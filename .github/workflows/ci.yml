name: CI

  on:
    push:
      branches: [main]
    pull_request:

  jobs:
    lint-test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - uses: dtolnay/rust-toolchain@stable
          with:
            components: rustfmt, clippy
            minimal: true

        - uses: Swatinem/rust-cache@v2
          with:
            cache-on-failure: true

        - run: cargo fmt --all --check

        - run: cargo clippy --workspace --all-targets --all-features -D warnings

        - run: cargo test --workspace --all-features --all-targets

    audit:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - uses: dtolnay/rust-toolchain@stable
        - uses: Swatinem/rust-cache@v2
        - run: cargo install cargo-deny --locked
        - run: cargo deny check bans advisories licenses sources

    coverage:
      runs-on: ubuntu-latest
      needs: lint-test
      if: github.event_name == 'pull_request'
      steps:
        - uses: actions/checkout@v4
        - uses: dtolnay/rust-toolchain@stable
        - uses: Swatinem/rust-cache@v2
        - run: cargo install cargo-llvm-cov --locked
        - run: cargo llvm-cov --workspace --all-features --lcov --output-path coverage.lcov
        - uses: actions/upload-artifact@v4
          with:
            name: coverage-lcov
            path: coverage.lcov