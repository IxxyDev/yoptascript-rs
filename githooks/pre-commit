#!/usr/bin/env bash
set -euo pipefail

RED="\033[31m"
GREEN="\033[32m"
RESET="\033[0m"

log() {
  printf "%b%s%b\n" "${GREEN}" "$1" "${RESET}"
}
err() {
  printf "%b%s%b\n" "${RED}" "$1" "${RESET}" >&2
}

log "Running cargo fmt --all"
cargo fmt --all

log "Restaging formatted files"
# Restage in case fmt produced changes
git add -A

log "Running cargo clippy --workspace --all-targets --all-features"
cargo clippy --workspace --all-targets --all-features -- -D warnings -W clippy::pedantic -W clippy::nursery || {
  err "cargo clippy failed" && exit 1
}

log "Running cargo test --workspace --all-targets --all-features"
cargo test --workspace --all-targets --all-features || {
  err "cargo test failed" && exit 1
}

log "Pre-commit checks passed"
